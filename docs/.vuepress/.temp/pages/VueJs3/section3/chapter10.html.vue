<template><div><h1 id="åŒç«¯-diff-ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#åŒç«¯-diff-ç®—æ³•" aria-hidden="true">#</a> åŒç«¯ Diff ç®—æ³•</h1>
<h2 id="åŒç«¯æ¯”è¾ƒåŸç†" tabindex="-1"><a class="header-anchor" href="#åŒç«¯æ¯”è¾ƒåŸç†" aria-hidden="true">#</a> åŒç«¯æ¯”è¾ƒåŸç†</h2>
<h3 id="ç®€å•-diff" tabindex="-1"><a class="header-anchor" href="#ç®€å•-diff" aria-hidden="true">#</a> ç®€å• Diff</h3>
<p>ç®€å• Diff ç®—æ³•çš„é—®é¢˜åœ¨äºï¼Œå®ƒå¯¹ DOM çš„ç§»åŠ¨æ“ä½œå¹¶ä¸æ˜¯æœ€ä¼˜çš„ã€‚ä»¥ä¸‹é¢è¿™ä¸ªå­èŠ‚ç‚¹åˆ—è¡¨æ›´æ–°ä¸ºä¾‹ï¼š
<img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/simpleDiff.png" alt=""></p>
<p>å¦‚å›¾å¯è§ï¼Œä½¿ç”¨ç®€å• diff ç®—æ³•åœ¨æœ¬æ¬¡æ¯”è¾ƒè¿‡ç¨‹ä¸­éœ€è¦ä¸¤æ¬¡ DOM ç§»åŠ¨æ“ä½œï¼Œåˆ†åˆ«æ˜¯å°† p-1 å’Œ p-2 ç§»åŠ¨åˆ° p-3 ä¹‹åã€‚</p>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.1.1.png" alt=""></p>
<p>ç„¶è€Œï¼Œä¸Šè¿°æ›´æ–°è¿‡ç¨‹å¹¶é<strong>æœ€ä¼˜è§£</strong>ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬åªè¦ä¸€æ¬¡ DOM ç§»åŠ¨æ“ä½œå³å¯å®Œæˆæ›´æ–°ï¼Œå³å°†çœŸå® DOM èŠ‚ç‚¹ p-3 ç§»åŠ¨åˆ°çœŸå® DOM èŠ‚ç‚¹ p-1 å‰é¢ã€‚</p>
<h3 id="åŒç«¯-diff" tabindex="-1"><a class="header-anchor" href="#åŒç«¯-diff" aria-hidden="true">#</a> åŒç«¯ Diff</h3>
<div class="custom-container tip"><p class="custom-container-title">åŒç«¯ Diff ç®—æ³•ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä½¿ç”¨å››ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘æ–°æ—§å­èŠ‚ç‚¹æ•°ç»„çš„å¤´å°¾ï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„é¡ºåºä»å¤´å°¾å‘ä¸­é—´è¿›è¡Œéå†å¤„ç†ï¼š</p>
<ul>
<li>è·¯çº¿ 1 åŒ¹é…ï¼Œè‡ªå¢ newStartIdx å’Œ oldStartIdx</li>
<li>è·¯çº¿ 2 åŒ¹é…ï¼Œè‡ªå‡ newEndIdx å’Œ oldEndIdx</li>
<li>è·¯çº¿ 3 åŒ¹é…ï¼Œè¡¨ç¤ºåŸæœ¬åœ¨å¤´éƒ¨çš„èŠ‚ç‚¹ç°åœ¨è¦ç§»åŠ¨åˆ°å°¾éƒ¨ï¼Œé‚£ä¹ˆç§»åŠ¨çœŸå® DOM çš„ oldStartIdx å¯¹åº”èŠ‚ç‚¹åˆ° oldEndIdx èŠ‚ç‚¹ä¹‹å</li>
<li>è·¯çº¿ 4 åŒ¹é…ï¼Œè¡¨ç¤ºåŸæœ¬åœ¨å°¾éƒ¨çš„èŠ‚ç‚¹ç°åœ¨è¦ç§»åŠ¨åˆ°å¤´éƒ¨ï¼Œé‚£ä¹ˆç§»åŠ¨çœŸå® DOM çš„ oldEndIdx å¯¹åº”èŠ‚ç‚¹åˆ° oldStartIdx èŠ‚ç‚¹ä¹‹å‰</li>
</ul>
</div>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.1.2.png" alt=""></p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children

    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>

    <span class="token keyword">let</span> oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldStartIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> oldEndVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newStartIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> newEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">,</span> newEndVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            oldEndVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">,</span> newEndVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            <span class="token function">insert</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> newEndVNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span>
            oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            <span class="token function">insert</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
            oldEndVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/diff.png" alt=""></p>
<p>æ­¤æ—¶ï¼ŒçœŸå® DOM èŠ‚ç‚¹çš„é¡ºåºä¸æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹çš„é¡ºåºç›¸åŒäº†ï¼šp-4ã€p-2ã€p-1ã€p-3ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨è¿™ä¸€è½®æ›´æ–°å®Œæˆä¹‹åï¼Œæ‰€æœ‰ newStartIdx å’Œæ‰€æœ‰ oldStartIdx çš„å€¼éƒ½å°äº newEndIdx å’Œ oldEndIdxã€‚å¾ªç¯ç»ˆæ­¢ï¼ŒåŒç«¯ Diff æ‰§è¡Œå®Œæ¯•ã€‚</p>
<h2 id="åŒç«¯æ¯”è¾ƒçš„ä¼˜åŠ¿" tabindex="-1"><a class="header-anchor" href="#åŒç«¯æ¯”è¾ƒçš„ä¼˜åŠ¿" aria-hidden="true">#</a> åŒç«¯æ¯”è¾ƒçš„ä¼˜åŠ¿</h2>
<p>ç»è¿‡åˆ†æåŒç«¯ Diff ç®—æ³•ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦<strong>ä¸€æ¬¡</strong> DOM ç§»åŠ¨æ“ä½œï¼Œè€Œä¹‹å‰çš„ç®€å• Diff ç®—æ³•éœ€è¦ä¸¤æ¬¡ç§»åŠ¨æ“ä½œã€‚</p>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.1.1.png" alt=""></p>
<h2 id="éç†æ€§çŠ¶å†µçš„å¤„ç†æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#éç†æ€§çŠ¶å†µçš„å¤„ç†æ–¹å¼" aria-hidden="true">#</a> éç†æ€§çŠ¶å†µçš„å¤„ç†æ–¹å¼</h2>
<p>åœ¨ä¹‹å‰çš„ä¾‹å­å½“ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ¯”è¾ƒç†æ€§çš„ä¾‹å­ã€‚Diff è¿‡ç¨‹ä¸­æ€»ä¼šå‘½ä¸­å››ä¸ªæ­¥éª¤ä¸­çš„ä¸€ä¸ªï¼Œè¿™æ˜¯éå¸¸ç†æƒ³çš„æƒ…å†µã€‚ä½†å®é™…ä¸Šï¼Œå¹¶éæ‰€æœ‰æƒ…å†µéƒ½è¿™ä¹ˆç†æƒ³ï¼š</p>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.3.1.png" alt=""></p>
<p>ä½¿ç”¨ç›®å‰çš„åŒç«¯ Diff ç®—æ³•è¿›è¡Œå¤„ç†ï¼Œä¼šå‘ç°æ— æ³•å‘½ä¸­å››ä¸ªæ­¥éª¤çš„ä»»ä½•ä¸€æ­¥ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åªèƒ½å¢åŠ é¢å¤–çš„æ­¥éª¤æ¥å¤„ç†è¿™ç§æƒ…å†µ</p>
<p>ğŸš€ å…·ä½“çš„åšæ³•æ˜¯ï¼Œæ‹¿æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­çš„å¤´éƒ¨èŠ‚ç‚¹å»æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­å¯»æ‰¾ã€‚å¦‚æœæ‰¾åˆ°äº†å¯å¤ç”¨çš„æ—§èŠ‚ç‚¹ï¼ŒæŠŠè¿™ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°å¤´éƒ¨ï¼Œå¹¶æŠŠè¿™ä¸ªæ—§èŠ‚ç‚¹æ ‡è®°ä¸º undefinedï¼Œåç»­æ‰§è¡Œå¦‚æœé‡åˆ° undefined æ—§èŠ‚ç‚¹ç›´æ¥è·³è¿‡å³å¯ã€‚</p>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.3.2.png" alt=""></p>
<p>ä»£ç éœ€è¦æ–°å¢ä¸€ä¸ªåˆ†æ”¯æ¥å¤„ç†ä¸ºå‘½ä¸­çš„æƒ…å†µï¼Œå¦å¤–éœ€è¦è·³è¿‡æ—§å­èŠ‚ç‚¹ä¸º undefined çš„æƒ…å†µï¼š</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ—§èŠ‚ç‚¹ä¸º undefinedï¼Œè·³è¿‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldStartVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldEndVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            oldEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">,</span> newEndVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            oldEndVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">,</span> newEndVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            <span class="token function">insert</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> newEndVNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span>
            oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            <span class="token function">insert</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
            oldEndVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// éå†æ—§ childrenï¼Œè¯•å›¾å¯»æ‰¾ä¸ newStartVNode æ‹¥æœ‰ç›¸åŒ key å€¼çš„å…ƒç´ </span>
            <span class="token keyword">const</span> idxInOld <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
                <span class="token parameter">node</span> <span class="token operator">=></span> node<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key
            <span class="token punctuation">)</span>
            <span class="token comment">// ç§»åŠ¨è¯¥èŠ‚ç‚¹åˆ°å­èŠ‚ç‚¹å¤´éƒ¨ï¼Œå¹¶æ ‡è®°ä¸º undefined</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>idxInOld <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> vnodeToMove <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
                <span class="token function">insert</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
                oldChildren<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
                newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åï¼Œå¯¹äºç›®å‰çš„è¿™ä¸ªä¾‹å­ï¼Œåç»­çš„å¤„ç†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.3.3.png" alt=""></p>
<h2 id="æ·»åŠ æ–°å…ƒç´ " tabindex="-1"><a class="header-anchor" href="#æ·»åŠ æ–°å…ƒç´ " aria-hidden="true">#</a> æ·»åŠ æ–°å…ƒç´ </h2>
<h3 id="ä¸€è½®æœªåŒ¹é…" tabindex="-1"><a class="header-anchor" href="#ä¸€è½®æœªåŒ¹é…" aria-hidden="true">#</a> ä¸€è½®æœªåŒ¹é…</h3>
<p>åœ¨ä¹‹å‰çš„å¤„ç†ä¸­ï¼Œå¦‚æœåœ¨<strong>ä¸€è½®æ¯”è¾ƒ</strong>ä¸­ï¼Œä»£ç ä¸ä¼šå‘½ä¸­å››ä¸ªæ­¥éª¤çš„ä»»ä½•ä¸€æ­¥ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬ä¼šæ‹¿æ–°å­èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å»æ—§å­èŠ‚ç‚¹åˆ—è¡¨ä¸­å¯»æ‰¾å¯å¤ç”¨èŠ‚ç‚¹ï¼Œç„¶è€Œå¹¶éæ€»æ˜¯èƒ½æ‰¾åˆ°ï¼šp-4ã€p-1ã€p-3ã€p-2</p>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.4.1.png" alt=""></p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°è¯•ä¸€è½®æ¯”è¾ƒï¼Œå‘ç°åœ¨å››ä¸ªæ­¥éª¤çš„æ¯”è¾ƒä¸­éƒ½æ‰¾ä¸æ‰“å¯å¤ç”¨çš„èŠ‚ç‚¹ã€‚äºæ˜¯æˆ‘ä»¬å°è¯•æ‹¿æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ p-4 å»æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹å½“ä¸­å¯»æ‰¾å¯å¤ç”¨èŠ‚ç‚¹ï¼Œä½†æ˜¯åœ¨æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹å½“ä¸­å¹¶æ²¡æœ‰åŒ¹é…åˆ° key ç›¸åŒçš„èŠ‚ç‚¹ã€‚</p>
<p>ğŸš€ è¯´æ˜è¿™ä¸ªèŠ‚ç‚¹æ˜¯æ–°å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯æ–°å­èŠ‚ç‚¹çš„å¤´éƒ¨èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ªèŠ‚ç‚¹<strong>æŒ‚è½½åˆ°å½“å‰çš„å¤´éƒ¨èŠ‚ç‚¹</strong>å³å¯ã€‚</p>
<h3 id="éå†è¢«é—æ¼" tabindex="-1"><a class="header-anchor" href="#éå†è¢«é—æ¼" aria-hidden="true">#</a> éå†è¢«é—æ¼</h3>
<p>é™¤äº†åœ¨ä¸€è½®æ¯”è¾ƒå½“ä¸­æœªåŒ¹é…æ­¥éª¤çš„æƒ…å†µï¼Œæˆ‘ä»¬æ›´æ”¹ä¹‹å‰çš„ä¾‹å­ä¸ºï¼šp-4ã€p-1ã€p-2ã€p-3</p>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.4.2.png" alt=""></p>
<p>å½“åŒç«¯ Diff å¤šè½®å¤„ç†å®Œæ¯•ä¹‹åï¼Œå‰©ä¸‹äº†ä¸€ä¸ª p-4èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹åœ¨æ•´ä¸ªæ›´æ–°è¿‡ç¨‹ä¸­è¢«é—æ¼äº†ï¼Œæ²¡æœ‰å¾—åˆ°ä»»ä½•å¤„ç†ï¼Œè¯´æ˜ç›®å‰çš„ç®—æ³•è¿˜æœ‰ç¼ºé™·éœ€è¦é¢å¤–å¤„ç†ã€‚</p>
<p>ğŸš€ é—æ¼çš„æ–°å­èŠ‚ç‚¹éƒ½æ˜¯è¦æ–°å¢çš„æ–°å­èŠ‚ç‚¹ï¼ŒæŒ‰åºéå†æŒ‚è½½åˆ°å¤´éƒ¨å³å¯ã€‚</p>
<CodeGroup>
<CodeGroupItem title="ä¸€è½®æœªåŒ¹é…">
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">const</span> idxInOld <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
    <span class="token parameter">node</span> <span class="token operator">=></span> node<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key
<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>idxInOld <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vnodeToMove <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    <span class="token function">insert</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    oldChildren<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæœªæ‰¾åˆ°å¯å¤ç”¨èŠ‚ç‚¹ï¼Œå°†å½“å‰èŠ‚ç‚¹æŒ‚è½½åœ¨å¤´éƒ¨å³å¯</span>
    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></CodeGroupItem>
<CodeGroupItem title="éå†è¢«é—æ¼">
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndIdx <span class="token operator">&lt;</span> oldStartIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæ–°å­èŠ‚ç‚¹åˆ—è¡¨æœ‰å¤„ç†é—æ¼çš„èŠ‚ç‚¹ï¼Œåˆ™æ·»åŠ </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></CodeGroupItem>
<CodeGroupItem title="å®Œæ•´ä»£ç ">
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldChildren <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>

    <span class="token keyword">let</span> oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldStartIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> oldEndVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newStartIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> newEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldStartVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldEndVNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            oldEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">,</span> newEndVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            oldEndVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newEndVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">,</span> newEndVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            <span class="token function">insert</span><span class="token punctuation">(</span>oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldEndVNode<span class="token punctuation">.</span>el<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span>

            oldStartVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
            newEndVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            <span class="token function">insert</span><span class="token punctuation">(</span>oldEndVNode<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
            
            oldEndVNode <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
            newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> idxInOld <span class="token operator">=</span> oldChildren<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
                <span class="token parameter">node</span> <span class="token operator">=></span> node<span class="token punctuation">.</span>key <span class="token operator">===</span> newStartVNode<span class="token punctuation">.</span>key
            <span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>idxInOld <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‰¾åˆ°å¯å¤ç”¨çš„å¤´éƒ¨èŠ‚ç‚¹ï¼Œpatch &amp; ç§»åŠ¨åˆ°å¤´éƒ¨</span>
                <span class="token keyword">const</span> vnodeToMove <span class="token operator">=</span> oldChildren<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
                <span class="token function">insert</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
                oldChildren<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœæœªæ‰¾åˆ°å¯å¤ç”¨èŠ‚ç‚¹ï¼Œå°†å½“å‰èŠ‚ç‚¹æŒ‚è½½åœ¨å¤´éƒ¨å³å¯</span>
                <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newStartVNode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            newStartVNode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndIdx <span class="token operator">&lt;</span> oldStartIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ–°å­èŠ‚ç‚¹åˆ—è¡¨æœ‰å¤„ç†é—æ¼çš„èŠ‚ç‚¹ï¼Œåˆ™æ·»åŠ </span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndIdx <span class="token operator">&lt;</span> newStartIdx <span class="token operator">&amp;&amp;</span> oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ—§å­èŠ‚ç‚¹åˆ—è¡¨æœ‰å¤„ç†é—æ¼çš„èŠ‚ç‚¹ï¼Œåˆ™å¸è½½</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">unmount</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></CodeGroupItem>
</CodeGroup>
<h2 id="ç§»é™¤ä¸å­˜åœ¨çš„å…ƒç´ " tabindex="-1"><a class="header-anchor" href="#ç§»é™¤ä¸å­˜åœ¨çš„å…ƒç´ " aria-hidden="true">#</a> ç§»é™¤ä¸å­˜åœ¨çš„å…ƒç´ </h2>
<p>åœ¨åŒç«¯ Diff å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæœªè¢«å¤ç”¨çš„æ—§å­èŠ‚ç‚¹å°±æ˜¯éœ€è¦å¸è½½çš„èŠ‚ç‚¹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/caffreygo/static/main/blog/Vuejs3/10.5.1.png" alt=""></p>
<p>ğŸš€ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“ diff å¤šè½®å¤„ç†å®Œæ¯•ä¹‹åï¼Œp-2 è¿™ä¸ªèŠ‚ç‚¹å¤„åœ¨ [oldStartIdx, oldEndIdx] åŒºé—´å†…ï¼Œè¯´æ˜è¿™ä¸ªèŠ‚ç‚¹æœªè¢«å¤ç”¨åˆ°ï¼Œåº”è¯¥è¢«å¸è½½ã€‚</p>
<div class="language-javascript ext-js line-numbers-mode"><pre v-pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndIdx <span class="token operator">&lt;</span> oldStartIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ·»åŠ æ–°èŠ‚ç‚¹</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> newStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> oldStartVNode<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndIdx <span class="token operator">&lt;</span> newStartIdx <span class="token operator">&amp;&amp;</span> oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç§»é™¤æ—§èŠ‚ç‚¹</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> oldStartIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> oldEndIdx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">unmount</span><span class="token punctuation">(</span>oldChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2>
<p>åŒç«¯ Diff æŒ‡çš„æ˜¯ï¼Œåœ¨æ–°æ—§ä¸¤ç»„å­èŠ‚ç‚¹çš„å››ä¸ªç«¯ç‚¹ä¹‹é—´åˆ†åˆ«è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶è¯•å›¾æ‰¾åˆ°å¯ä»¥å¤ç”¨çš„èŠ‚ç‚¹ã€‚ç›¸æ¯”ç®€å• Diff ç®—æ³•ï¼ŒåŒç«¯ Diff ç®—æ³•çš„ä¼˜åŠ¿åœ¨äºï¼Œå¯¹äºåŒæ ·çš„æ›´æ–°åœºæ™¯ï¼Œæ‰§è¡Œçš„ <strong>DOM ç§»åŠ¨æ“ä½œæ¬¡æ•°æ›´å°‘</strong>ã€‚</p>
</div></template>
